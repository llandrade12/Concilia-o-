<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Entrada de Dados Detalhada - ESPARTANO 2">
  <title>Entrada de Dados Detalhada - ESPARTANO</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  
  <link rel="stylesheet" href="styles.css">
  <style>
    .data-entry-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      margin-bottom: 18px;
    }

    .entry-section {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.015 ), rgba(255, 255, 255, 0.01));
      border-radius: 10px;
      padding: 18px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-md);
    }

    .entry-section h2 {
      margin: 0 0 16px 0;
      color: var(--accent);
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .form-row.full {
      grid-template-columns: 1fr;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      background: var(--card);
      color: var(--white);
      border: 1px solid var(--border);
      font-size: 0.95rem;
      transition: var(--transition);
      font-family: inherit;
    }

    .form-group input:focus {
      outline: 2px solid rgba(14, 165, 164, 0.12);
      border-color: rgba(14, 165, 164, 0.2);
      background: rgba(17, 24, 39, 0.8);
    }

    .form-group input:hover {
      border-color: rgba(255, 255, 255, 0.1);
    }

    .btn-add-row {
      background: linear-gradient(90deg, var(--success), #06b6a4);
      color: #042c2e;
      width: 100%;
      justify-content: center;
      padding: 10px 16px;
      margin-top: 12px;
    }

    .btn-add-row:hover {
      background: linear-gradient(90deg, #059669, #0d9488);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 0.9rem;
      color: var(--white);
      overflow-x: auto;
    }

    .data-table thead th {
      background: rgba(255, 255, 255, 0.02);
      color: var(--muted);
      font-weight: 700;
      font-size: 0.8rem;
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .data-table tbody td {
      padding: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      vertical-align: middle;
    }

    .data-table tbody tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.012);
    }

    .data-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .btn-delete-row {
      background: #b91c1c;
      padding: 4px 8px;
      font-size: 0.8rem;
    }

    .btn-delete-row:hover {
      background: #991b1b;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .btn-export {
      background: linear-gradient(90deg, #16a34a, #059669);
      flex: 1;
      justify-content: center;
    }

    .btn-export:hover {
      background: linear-gradient(90deg, #15803d, #047857);
    }

    .btn-copy {
      background: linear-gradient(90deg, #0ea5a4, #0d9488);
      flex: 1;
      justify-content: center;
    }

    .btn-copy:hover {
      background: linear-gradient(90deg, #0d9488, #14b8a6);
    }

    .btn-back {
      background: #374151;
      flex: 1;
      justify-content: center;
    }

    .btn-back:hover {
      background: #4b5563;
    }

    .stats-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.01);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.03);
    }

    .stat-item {
      text-align: center;
    }

    .stat-label {
      color: var(--muted);
      font-size: 0.8rem;
      margin-bottom: 4px;
    }

    .stat-value {
      color: var(--accent);
      font-weight: 700;
      font-size: 1.1rem;
    }

    .empty-message {
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-style: italic;
    }

    .success-message {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      display: none;
      font-size: 0.9rem;
    }

    .success-message.show {
      display: block;
      animation: slideIn 0.3s ease-in-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 1024px) {
      .data-entry-container {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .data-table {
        font-size: 0.8rem;
      }

      .data-table thead th,
      .data-table tbody td {
        padding: 6px;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn-export,
      .btn-copy,
      .btn-back {
        flex: 1;
      }
    }
    
    @media screen and (max-width: 768px) {
      .data-table thead {
        display: none;
      }

      .data-table, 
      .data-table tbody, 
      .data-table tr, 
      .data-table td {
        display: block;
        width: 100%;
      }

      .data-table tr {
        margin-bottom: 15px;
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.01);
      }
      
      .data-table tr.empty-message {
        border: none;
        background: transparent;
      }

      .data-table td {
        text-align: right;
        padding-left: 50%;
        position: relative;
        border-bottom: 1px solid var(--border);
      }

      .data-table td::before {
        content: attr(data-label);
        position: absolute;
        left: 10px;
        width: calc(50% - 20px);
        text-align: left;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        font-size: 0.75rem;
      }
      
      .data-table td:last-child {
        border-bottom: 0;
      }

      .data-table td[data-label="Ação"] {
        text-align: center;
        padding-left: 0;
      }
      .data-table td[data-label="Ação"]::before {
          display: none;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="app-header">
      <div class="title">
        <div class="logo">ES</div>
        <div>
          <h1>Entrada de Dados Detalhada</h1>
          <div class="subtitle">Renovações e Novos Clientes</div>
        </div>
      </div>

      <div class="header-actions">
        <button title="Salvar progresso localmente" onclick="salvarLocal(event)">
          <i class="fa-solid fa-save"></i> Salvar Local
        </button>
        <button title="Voltar para Conciliação" onclick="transferirParaConciliacao()">
          <i class="fa-solid fa-arrow-left"></i> Voltar
        </button>
      </div>
    </header>

    <main style="display: block; padding: 22px;">
      <div class="data-entry-container">
        <div class="entry-section">
          <h2><i class="fa-solid fa-retweet"></i> Renovações</h2>
          
          <div class="success-message" id="successRenovacao"></div>

          <div class="form-row full">
            <div class="form-group">
              <label for="cliente_renov">Cliente</label>
              <input type="text" id="cliente_renov" placeholder="Nome do cliente">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="cpf_renov">CPF</label>
              <input type="text" id="cpf_renov" placeholder="000.000.000-00">
            </div>
            <div class="form-group">
              <label for="telefone_renov">Telefone</label>
              <input type="text" id="telefone_renov" placeholder="(00) 00000-0000">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="dataInicial_renov">Data Inicial</label>
              <input type="date" id="dataInicial_renov" onchange="preencherDataFinal('renov')">
            </div>
            <div class="form-group">
              <label for="dataFinal_renov">Data Final</label>
              <input type="date" id="dataFinal_renov">
            </div>
          </div>

          <div class="form-row full">
            <div class="form-group">
              <label for="emprestimo_renov">Empréstimo (R$)</label>
              <input type="number" id="emprestimo_renov" placeholder="0.00" step="0.01">
            </div>
          </div>

          <button class="btn btn-add-row" onclick="adicionarRenovacao()">
            <i class="fa-solid fa-plus"></i> Adicionar Renovação
          </button>

          <div style="overflow-x: auto;">
            <table class="data-table" id="tabelaRenovacao">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Cliente</th>
                  <th>CPF</th>
                  <th>Telefone</th>
                  <th>Data Inicial</th>
                  <th>Data Final</th>
                  <th>Empréstimo</th>
                  <th>Ação</th>
                </tr>
              </thead>
              <tbody id="corpoRenovacao">
                <tr class="empty-message">
                  <td colspan="8">Nenhum registro adicionado</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="stats-row">
            <div class="stat-item">
              <div class="stat-label">Total de Registros</div>
              <div class="stat-value" id="totalRenovacao">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Total Empréstimos</div>
              <div class="stat-value" id="totalEmprestimoRenovacao">R$ 0,00</div>
            </div>
          </div>

          <div class="action-buttons">
            <button class="btn btn-export" onclick="exportarExcelRenovacao()">
              <i class="fa-solid fa-file-excel"></i> Exportar Excel
            </button>
            <button class="btn btn-copy" onclick="copiarClipboardRenovacao()">
              <i class="fa-solid fa-copy"></i> Copiar
            </button>
          </div>
        </div>

        <div class="entry-section">
          <h2><i class="fa-solid fa-user-plus"></i> Novos Clientes</h2>
          
          <div class="success-message" id="successNovo"></div>

          <div class="form-row full">
            <div class="form-group">
              <label for="cliente_novo">Cliente</label>
              <input type="text" id="cliente_novo" placeholder="Nome do cliente">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="cpf_novo">CPF</label>
              <input type="text" id="cpf_novo" placeholder="000.000.000-00">
            </div>
            <div class="form-group">
              <label for="telefone_novo">Telefone</label>
              <input type="text" id="telefone_novo" placeholder="(00) 00000-0000">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="dataInicial_novo">Data Inicial</label>
              <input type="date" id="dataInicial_novo" onchange="preencherDataFinal('novo')">
            </div>
            <div class="form-group">
              <label for="dataFinal_novo">Data Final</label>
              <input type="date" id="dataFinal_novo">
            </div>
          </div>

          <div class="form-row full">
            <div class="form-group">
              <label for="emprestimo_novo">Empréstimo (R$)</label>
              <input type="number" id="emprestimo_novo" placeholder="0.00" step="0.01">
            </div>
          </div>

          <button class="btn btn-add-row" onclick="adicionarClienteNovo()">
            <i class="fa-solid fa-plus"></i> Adicionar Cliente Novo
          </button>

          <div style="overflow-x: auto;">
            <table class="data-table" id="tabelaNovo">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Cliente</th>
                  <th>CPF</th>
                  <th>Telefone</th>
                  <th>Data Inicial</th>
                  <th>Data Final</th>
                  <th>Empréstimo</th>
                  <th>Ação</th>
                </tr>
              </thead>
              <tbody id="corpoNovo">
                <tr class="empty-message">
                  <td colspan="8">Nenhum registro adicionado</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="stats-row">
            <div class="stat-item">
              <div class="stat-label">Total de Registros</div>
              <div class="stat-value" id="totalNovo">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Total Empréstimos</div>
              <div class="stat-value" id="totalEmprestimoNovo">R$ 0,00</div>
            </div>
          </div>

          <div class="action-buttons">
            <button class="btn btn-export" onclick="exportarExcelNovo()">
              <i class="fa-solid fa-file-excel"></i> Exportar Excel
            </button>
            <button class="btn btn-copy" onclick="copiarClipboardNovo()">
              <i class="fa-solid fa-copy"></i> Copiar
            </button>
          </div>
        </div>
      </div>

      <div style="margin-top: 18px; text-align: center;">
        <button class="btn btn-back" onclick="transferirParaConciliacao()">
          <i class="fa-solid fa-arrow-left"></i> Voltar para Conciliação
        </button>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    let dadosRenovacao = [];
    let dadosNovo = [];

    function formatarMoeda(valor ) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(valor);
    }

    function formatarData(dataStr) {
      if (!dataStr) return '';
      const [ano, mes, dia] = dataStr.split('-');
      return `${dia}/${mes}/${ano}`;
    }

    function mostrarSucesso(elementId, mensagem) {
      const el = document.getElementById(elementId);
      el.textContent = mensagem;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 3000);
    }

    function preencherDataFinal(prefixo) {
      const dataInicialInput = document.getElementById(`dataInicial_${prefixo}`);
      const dataFinalInput = document.getElementById(`dataFinal_${prefixo}`);
      
      if (dataInicialInput.value) {
        const dataInicial = new Date(dataInicialInput.value + 'T00:00:00');
        const dataFinal = new Date(dataInicial);
        dataFinal.setDate(dataFinal.getDate() + 19);
        
        const ano = dataFinal.getFullYear();
        const mes = String(dataFinal.getMonth() + 1).padStart(2, '0');
        const dia = String(dataFinal.getDate()).padStart(2, '0');
        
        dataFinalInput.value = `${ano}-${mes}-${dia}`;
      }
    }

    function limparFormulario(prefixo) {
      document.getElementById(`cliente_${prefixo}`).value = '';
      document.getElementById(`cpf_${prefixo}`).value = '';
      document.getElementById(`telefone_${prefixo}`).value = '';
      document.getElementById(`dataInicial_${prefixo}`).value = '';
      document.getElementById(`dataFinal_${prefixo}`).value = '';
      document.getElementById(`emprestimo_${prefixo}`).value = '';
    }

    function atualizarStats(tipo) {
      const dados = tipo === 'renovacao' ? dadosRenovacao : dadosNovo;
      const totalEl = document.getElementById(`total${tipo === 'renovacao' ? 'Renovacao' : 'Novo'}`);
      const totalEmpEl = document.getElementById(`totalEmprestimo${tipo === 'renovacao' ? 'Renovacao' : 'Novo'}`);
      
      const total = dados.length;
      const totalEmp = dados.reduce((sum, item) => sum + parseFloat(item.emprestimo || 0), 0);
      
      totalEl.textContent = total;
      totalEmpEl.textContent = formatarMoeda(totalEmp);
    }

    function atualizarTabela(tipo) {
      const dados = tipo === 'renovacao' ? dadosRenovacao : dadosNovo;
      const corpoId = tipo === 'renovacao' ? 'corpoRenovacao' : 'corpoNovo';
      const corpo = document.getElementById(corpoId);

      if (dados.length === 0) {
        corpo.innerHTML = '<tr class="empty-message"><td colspan="8">Nenhum registro adicionado</td></tr>';
        atualizarStats(tipo);
        return;
      }

      corpo.innerHTML = dados.map((item, idx) => `
        <tr>
          <td data-label="#">${idx + 1}</td>
          <td data-label="Cliente">${item.cliente}</td>
          <td data-label="CPF">${item.cpf}</td>
          <td data-label="Telefone">${item.telefone}</td>
          <td data-label="Data Inicial">${formatarData(item.dataInicial)}</td>
          <td data-label="Data Final">${formatarData(item.dataFinal)}</td>
          <td data-label="Empréstimo">${formatarMoeda(item.emprestimo)}</td>
          <td data-label="Ação">
            <button class="btn btn-delete-row" onclick="deletarRegistro('${tipo}', ${idx})">
              <i class="fa-solid fa-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');

      atualizarStats(tipo);
    }

    function deletarRegistro(tipo, idx) {
      if (confirm('Deseja realmente remover este registro?')) {
        if (tipo === 'renovacao') {
          dadosRenovacao.splice(idx, 1);
        } else {
          dadosNovo.splice(idx, 1);
        }
        atualizarTabela(tipo);
        mostrarSucesso(`success${tipo === 'renovacao' ? 'Renovacao' : 'Novo'}`, '✅ Registro removido!');
      }
    }

    function adicionarRenovacao() {
      const cliente = document.getElementById('cliente_renov').value.trim();
      const cpf = document.getElementById('cpf_renov').value.trim();
      const telefone = document.getElementById('telefone_renov').value.trim();
      const dataInicial = document.getElementById('dataInicial_renov').value;
      const dataFinal = document.getElementById('dataFinal_renov').value;
      const emprestimo = parseFloat(document.getElementById('emprestimo_renov').value) || 0;

      if (!cliente || !cpf || !telefone || !dataInicial || !dataFinal || emprestimo === 0) {
        alert('⚠️ Preencha todos os campos!');
        return;
      }

      dadosRenovacao.push({ cliente, cpf, telefone, dataInicial, dataFinal, emprestimo });
      atualizarTabela('renovacao');
      limparFormulario('renov');
      mostrarSucesso('successRenovacao', '✅ Renovação adicionada!');
    }

    function adicionarClienteNovo() {
      const cliente = document.getElementById('cliente_novo').value.trim();
      const cpf = document.getElementById('cpf_novo').value.trim();
      const telefone = document.getElementById('telefone_novo').value.trim();
      const dataInicial = document.getElementById('dataInicial_novo').value;
      const dataFinal = document.getElementById('dataFinal_novo').value;
      const emprestimo = parseFloat(document.getElementById('emprestimo_novo').value) || 0;

      if (!cliente || !cpf || !telefone || !dataInicial || !dataFinal || emprestimo === 0) {
        alert('⚠️ Preencha todos os campos!');
        return;
      }

      dadosNovo.push({ cliente, cpf, telefone, dataInicial, dataFinal, emprestimo });
      atualizarTabela('novo');
      limparFormulario('novo');
      mostrarSucesso('successNovo', '✅ Cliente novo adicionado!');
    }

    function exportarExcel(dados, nomeArquivo) {
      if (dados.length === 0) {
        alert('⚠️ Nenhum dado para exportar!');
        return;
      }
      if (typeof XLSX === 'undefined') {
        alert('Erro: A biblioteca de exportação (XLSX) não foi carregada. Verifique a conexão com a internet.');
        return;
      }

      const dadosParaPlanilha = dados.map(item => ({
        'Cliente': item.cliente,
        'CPF': item.cpf,
        'Telefone': item.telefone,
        'Data Inicial': formatarData(item.dataInicial),
        'Data Final': formatarData(item.dataFinal),
        'Empréstimo': item.emprestimo
      }));

      const ws = XLSX.utils.json_to_sheet(dadosParaPlanilha);

      ws['!cols'] = [
        { wch: 30 }, { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 12 }, { wch: 15 }
      ];
      
      for (let i = 2; i <= dadosParaPlanilha.length + 1; i++) {
        const cellRef = `F${i}`;
        if (ws[cellRef]) {
          ws[cellRef].t = 'n';
          ws[cellRef].z = 'R$ #,##0.00';
        }
      }

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Dados');

      const nomeFinal = `${nomeArquivo}_${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, nomeFinal);
      
      mostrarSucesso(nomeArquivo === 'Renovacoes' ? 'successRenovacao' : 'successNovo', '✅ Arquivo Excel exportado!');
    }

    function exportarExcelRenovacao() {
      exportarExcel(dadosRenovacao, 'Renovacoes');
    }

    function exportarExcelNovo() {
      exportarExcel(dadosNovo, 'Novos_Clientes');
    }

    function copiarClipboard(dados, successId) {
      if (dados.length === 0) {
        alert('⚠️ Nenhum dado para copiar!');
        return;
      }

      let tsv = dados.map(item => {
        const emp = item.emprestimo.toString().replace('.', ',');
        return `${item.cliente}\t${emp}`;
      }).join('\n');

      navigator.clipboard.writeText(tsv).then(() => {
        mostrarSucesso(successId, '✅ Nome e Empréstimo copiados! Cole no Excel.');
      }).catch(() => {
        alert('❌ Erro ao copiar!');
      });
    }

    function copiarClipboardRenovacao() {
      copiarClipboard(dadosRenovacao, 'successRenovacao');
    }

    function copiarClipboardNovo() {
      copiarClipboard(dadosNovo, 'successNovo');
    }

    function salvarLocal(event) {
        const dataPayload = {
            renovacoes: dadosRenovacao,
            novos: dadosNovo
        };
        localStorage.setItem('espartano_dados_detalhados', JSON.stringify(dataPayload));

        const botao = event.target.closest('button');
        const textoOriginal = botao.innerHTML;
        botao.innerHTML = '<i class="fa-solid fa-check"></i> Salvo!';
        setTimeout(() => {
            botao.innerHTML = textoOriginal;
        }, 2000);
        mostrarSucesso('successRenovacao', '✅ Progresso salvo no navegador!');
    }

    function transferirParaConciliacao() {
        const dadosParaTransferir = {
            renovacoes: dadosRenovacao.map(item => ({ nome: item.cliente, valor: item.emprestimo })),
            novos: dadosNovo.map(item => ({ nome: item.cliente, valor: item.emprestimo }))
        };
        localStorage.setItem('espartano2_transferencia', JSON.stringify(dadosParaTransferir));
        window.location.href = 'index.html';
    }

    window.addEventListener('load', function() {
        const dadosSalvos = localStorage.getItem('espartano_dados_detalhados');
        if (dadosSalvos) {
            try {
                const data = JSON.parse(dadosSalvos);
                if (data.renovacoes) {
                    dadosRenovacao = data.renovacoes;
                    atualizarTabela('renovacao');
                }
                if (data.novos) {
                    dadosNovo = data.novos;
                    atualizarTabela('novo');
                }
            } catch (e) {
                console.error('Erro ao carregar dados locais:', e);
            }
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
      const inputsRenov = ['cliente_renov', 'cpf_renov', 'telefone_renov', 'dataInicial_renov', 'dataFinal_renov', 'emprestimo_renov'];
      const inputsNovo = ['cliente_novo', 'cpf_novo', 'telefone_novo', 'dataInicial_novo', 'dataFinal_novo', 'emprestimo_novo'];

      inputsRenov.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('keypress', e => e.key === 'Enter' && adicionarRenovacao());
      });

      inputsNovo.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('keypress', e => e.key === 'Enter' && adicionarClienteNovo());
      });
    });
  </script>
</body>
</html>
